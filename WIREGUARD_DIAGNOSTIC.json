{
  "issue": "WireGuard VPN Failure - resolvconf Init System Mismatch",
  "timestamp": "2024-01-26T21:08:41Z",
  "severity": "HIGH",
  "impact": "VPN cannot be established, blocking geo-restricted Polymarket API access",
  
  "root_cause": {
    "primary": "Alpine Linux container lacks a traditional init system (systemd/OpenRC) that resolvconf expects",
    "secondary": "resolvconf signature mismatch with /etc/resolv.conf prevents DNS configuration",
    "tertiary": "wg-quick aborts on resolvconf failure, tearing down the interface"
  },
  
  "failure_sequence": [
    {
      "step": 1,
      "action": "wg-quick up /etc/wireguard/wg0.conf",
      "result": "SUCCESS",
      "detail": "WireGuard interface wg0 created and configured correctly"
    },
    {
      "step": 2,
      "action": "ip link add dev wg0 type wireguard",
      "result": "SUCCESS"
    },
    {
      "step": 3,
      "action": "wg setconf wg0 /dev/fd/63",
      "result": "SUCCESS"
    },
    {
      "step": 4,
      "action": "ip -4 address add 10.151.22.111/32 dev wg0",
      "result": "SUCCESS"
    },
    {
      "step": 5,
      "action": "ip -6 address add fd7d:76ee:e68f:a993:c4ca:f41:f871:35b4/128 dev wg0",
      "result": "SUCCESS"
    },
    {
      "step": 6,
      "action": "ip link set mtu 1320 up dev wg0",
      "result": "SUCCESS",
      "detail": "Interface brought up with MTU 1320"
    },
    {
      "step": 7,
      "action": "resolvconf -a wg0 -m 0 -x",
      "result": "FAILED",
      "errors": [
        "resolvconf: could not detect a useable init system",
        "resolvconf: signature mismatch: /etc/resolv.conf",
        "resolvconf: run `resolvconf -u` to update"
      ],
      "detail": "DNS configuration failed - resolvconf cannot find init system"
    },
    {
      "step": 8,
      "action": "ip link delete dev wg0",
      "result": "SUCCESS",
      "detail": "wg-quick tears down interface on resolvconf failure"
    }
  ],
  
  "environment": {
    "base_image": "node:20-alpine",
    "container_runtime": "Docker",
    "init_system": "NONE (Alpine minimal container)",
    "packages_installed": [
      "wireguard-tools",
      "openvpn",
      "iproute2",
      "iptables",
      "openresolv"
    ],
    "dns_in_config": "OPTIONAL (WIREGUARD_DNS env var)"
  },
  
  "analysis": {
    "why_resolvconf_fails": [
      "Alpine containers typically don't run systemd or OpenRC",
      "resolvconf expects to communicate with a running init system",
      "/etc/resolv.conf may be managed by Docker daemon, not resolvconf",
      "Signature mismatch indicates /etc/resolv.conf is not under resolvconf control"
    ],
    "why_wg_quick_aborts": [
      "wg-quick executes commands sequentially and aborts on first error",
      "resolvconf failure is treated as fatal by wg-quick",
      "Interface teardown is automatic cleanup on failure"
    ],
    "dns_config_in_wireguard": [
      "WireGuard config supports optional DNS directive",
      "User may or may not have WIREGUARD_DNS set",
      "If DNS is specified, wg-quick tries to configure it via resolvconf",
      "No DNS directive = no resolvconf call = no failure"
    ]
  },
  
  "code_locations": {
    "vpn_module": "src/lib/vpn.ts",
    "start_wireguard": "src/lib/vpn.ts:259-356",
    "config_generation": "src/lib/vpn.ts:185-254",
    "dns_line": "src/lib/vpn.ts:225 (if (dns) config += `DNS = ${dns}\\n`;)",
    "wg_quick_invocation": "src/lib/vpn.ts:346 (execSync(`wg-quick up ${configPath}`, { stdio: 'pipe' }))",
    "dockerfile": "Dockerfile:47-48 (RUN apk add ... openresolv)"
  },
  
  "recommended_fixes": [
    {
      "priority": 1,
      "solution": "Strip DNS directive from WireGuard config when generating",
      "rationale": "If no DNS line exists in config, wg-quick won't call resolvconf",
      "implementation": "Comment out line 225 in vpn.ts or conditionally skip DNS config in containers",
      "pros": [
        "Minimal code change",
        "WireGuard will work immediately",
        "Container uses Docker-managed DNS (usually sufficient)"
      ],
      "cons": [
        "Custom DNS servers cannot be configured via WireGuard",
        "May not work if user requires specific DNS for VPN routing"
      ]
    },
    {
      "priority": 2,
      "solution": "Configure resolvconf to use a fallback method",
      "rationale": "Make resolvconf work without an init system",
      "implementation": "Add resolvconf configuration to Dockerfile: echo 'resolvconf=NO' > /etc/resolvconf.conf OR use unbound/dnsmasq",
      "pros": [
        "Preserves DNS configuration capability",
        "More robust for advanced VPN setups"
      ],
      "cons": [
        "More complex",
        "May still have /etc/resolv.conf signature issues",
        "Requires additional packages or configuration"
      ]
    },
    {
      "priority": 3,
      "solution": "Replace wg-quick with manual wg command sequence",
      "rationale": "Bypass wg-quick's resolvconf requirement entirely",
      "implementation": "Replace execSync('wg-quick up ...') with manual: ip link add, wg setconf, ip addr add, ip link set up",
      "pros": [
        "Full control over interface setup",
        "No dependency on resolvconf",
        "Can skip DNS configuration or handle it separately"
      ],
      "cons": [
        "Much more code",
        "Need to replicate wg-quick's routing logic",
        "Error handling complexity"
      ]
    },
    {
      "priority": 4,
      "solution": "Use a different base image with init system",
      "rationale": "Switch from Alpine to Ubuntu/Debian with systemd",
      "implementation": "Change Dockerfile: FROM node:20-alpine -> FROM node:20-slim",
      "pros": [
        "resolvconf works out of the box",
        "Standard Linux environment"
      ],
      "cons": [
        "Much larger image size (100MB+ vs 30MB Alpine)",
        "Slower builds and deployments",
        "systemd requires privileged container mode"
      ]
    }
  ],
  
  "immediate_workaround": {
    "solution": "Remove DNS directive from WireGuard config",
    "steps": [
      "If using WIREGUARD_DNS env var, unset it or leave it empty",
      "If using WIREGUARD_CONFIG with DNS line, remove the DNS line",
      "If using WG_CONFIG file, edit the file to remove DNS = ... line",
      "Restart container"
    ],
    "verification": "WireGuard should start without resolvconf errors",
    "dns_impact": "Container will use Docker's default DNS (usually 8.8.8.8 or host DNS)"
  },
  
  "long_term_fix": {
    "recommended_approach": "Priority 1 + Priority 2 hybrid",
    "implementation_plan": [
      "1. Modify vpn.ts to detect container environment (check for /.dockerenv or $container env)",
      "2. In containers, skip DNS directive generation even if WIREGUARD_DNS is set",
      "3. Add warning log: 'DNS config skipped in container - using Docker DNS'",
      "4. Document this behavior in vpn.ts header comments",
      "5. Optionally: Add resolvconf fallback config for advanced users who need custom DNS"
    ]
  },
  
  "auth_story_format": {
    "run_id": "wireguard-diagnostic-001",
    "attempts": [
      {
        "attempt": 1,
        "phase": "vpn_setup",
        "action": "wg-quick up wg0.conf",
        "result": "FAILED",
        "error_code": "RESOLVCONF_INIT_MISSING",
        "error_detail": "could not detect a useable init system",
        "duration_ms": 250,
        "interface_state": "torn_down"
      }
    ],
    "diagnosis": "Alpine container lacks init system for resolvconf DNS updates",
    "fix": "Remove DNS directive from WireGuard config or switch to manual wg commands",
    "impact": "VPN cannot connect, API calls may be geo-blocked"
  },
  
  "next_steps": [
    "1. Confirm user's WireGuard config includes DNS directive (likely yes based on logs)",
    "2. Implement Priority 1 fix: skip DNS config in container environments",
    "3. Test with user's credentials",
    "4. Document workaround in README and .env.example",
    "5. Add automated detection of this failure mode with actionable error message"
  ]
}
